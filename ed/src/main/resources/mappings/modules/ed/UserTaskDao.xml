<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.langheng.modules.ed.dao.UserTaskDao">
	
	<!-- 查询数据
	<select id="findList" resultType="UserTask">
		SELECT ${sqlMap.column.toSql()}
		FROM ${sqlMap.table.toSql()}
		<where>
			${sqlMap.where.toSql()}
		</where>
		ORDER BY ${sqlMap.order.toSql()}
	</select> -->

	<select id="findUnFinishLessonTaskCount" resultType="java.lang.Long">
		SELECT count(1) FROM ed_lesson_task AS a
		JOIN ed_teaching_class_lesson_task AS tclk ON tclk.lesson_task_id = a.lesson_task_id AND tclk.teaching_class_id =#{teachingClassId}
		WHERE
			a.status = '0' AND
			<if test=" lessonId!=null and lessonId != ''">
				a.lesson_id = #{lessonId} AND
			</if>
			 a.lesson_task_id NOT IN (SELECT lesson_task_id FROM ed_user_task AS uk
			 	WHERE  uk.state = '2' AND a.lesson_task_id = uk.lesson_task_id
					<if test=" userId!=null and userId != ''">
						AND uk.user_id = #{userId}
					</if> )
	</select>

	<select id="findTotalLessonTaskCount" resultType="java.lang.Long">
		SELECT count(1) FROM ed_lesson_task AS a
		JOIN ed_teaching_class_lesson_task AS tclk ON tclk.lesson_task_id = a.lesson_task_id AND tclk.teaching_class_id =#{teachingClassId}
		WHERE
			a.status = '0' AND
			<if test=" lessonId!=null and lessonId != ''">
				a.lesson_id = #{lessonId} AND
			</if>
			a.lesson_id IN (SELECT lesson_id FROM ed_teaching_class_lesson AS tcl  WHERE  tcl.teaching_class_id=#{teachingClassId}  )
	</select>

	<select id="findMyLessonTaskList" resultType="com.langheng.modules.ed.entity.LessonTask">
		SELECT a.*,uk.state AS finishState,uk.user_task_id AS userTaskId,uk.to_answer AS isRepeatAnswer,
		(SELECT tcs.score FROM ed_teaching_class_score as tcs
				WHERE  tcs.lesson_task_id = a.lesson_task_id and tcs.teaching_class_id= #{teachingClassId} ) AS modifyScore
		FROM ed_lesson_task AS a
		JOIN ed_teaching_class_lesson_task AS tclk ON tclk.lesson_task_id = a.lesson_task_id AND tclk.teaching_class_id =#{teachingClassId}
		LEFT JOIN ed_user_task as uk ON uk.lesson_task_id = a.lesson_task_id AND uk.user_id = #{userId}
		WHERE
			a.status = '0' AND
			a.lesson_id = #{lessonId}
		ORDER BY a.create_date ASC, a.sort ASC
	</select>

	<select id="findUnStartStudents" resultType="com.langheng.modules.ed.entity.StudentVo">
		SELECT user_code AS id, user_name, login_code,cover_img FROM sys_user AS a
		JOIN sys_student_classes AS sc ON sc.classes_id = #{classesId} AND a.user_code = sc.student_id
		WHERE a.status = '0' AND  a.user_type = '1' AND
		a.user_code NOT IN (SELECT user_id FROM ed_user_task AS uk WHERE uk.chapter_id =#{chapterId} )
	</select>

	<select id="findHadFinishStudents" resultType="com.langheng.modules.ed.entity.StudentVo">
		SELECT user_code AS id, user_name, login_code,cover_img FROM sys_user AS a
		JOIN sys_student_classes AS sc ON sc.classes_id = #{classesId} AND a.user_code = sc.student_id
		JOIN ed_user_chapter AS uc ON uc.user_id = a.user_code AND uc.chapter_id =#{chapterId}
		WHERE a.status = '0' AND  a.user_type = '1'
	</select>

	<select id="findStudentProgress" resultType="com.langheng.modules.ed.entity.StudentVo">
		SELECT user_code AS id, user_name, login_code,cover_img,
		(SELECT count(1) FROM ed_user_task AS uk WHERE uk.user_id= a.user_code AND  uk.state= '2' AND uk.teaching_class_id=#{teachingClassId} ) AS hadFinishLessonTaskNum,
		(SELECT count(1) FROM ed_user_task AS uk WHERE uk.user_id= a.user_code AND  uk.state= '2' AND uk.teaching_class_id=#{teachingClassId} AND uk.chapter_id=#{chapterId} ) AS newChapterHadFinishLessonTaskNum,
		(SELECT sum(uk.score) FROM ed_user_task AS uk WHERE (uk.type='2' OR uk.type='3')  AND uk.user_id= a.user_code AND uk.teaching_class_id=#{teachingClassId} ) AS grossScore
		FROM sys_user AS a
		JOIN sys_student_classes AS sc ON sc.classes_id = #{classesId} AND a.user_code = sc.student_id
		WHERE a.status = '0' AND  a.user_type = '1'
		ORDER BY hadFinishLessonTaskNum DESC
	</select>

	<select id="getAverageScore" resultType="Float">
		SELECT AVG(score) FROM ed_user_task AS a
		WHERE teaching_class_id =  #{teachingClassId} AND state = '2' AND type= #{lessonTaskType};
	</select>

	<select id="qualityMatrix" resultType="com.langheng.modules.ed.entity.QualityMatrixVo">
		SELECT user_code AS id, user_name, login_code,
		(SELECT count(1) FROM ed_user_task AS uk
			WHERE uk.user_id= a.user_code AND uk.state = '2'
					<if test="chapterId!=null and chapterId!=''"> AND uk.chapter_id=#{chapterId}  </if>
			 	  AND uk.teaching_class_id=#{teachingClassId} ) AS hadFinishLessonTaskNum,
		(SELECT sum(uk.score) FROM ed_user_task AS uk
			WHERE uk.type='3' AND uk.user_id= a.user_code AND uk.state = '2'
					<if test="chapterId!=null and chapterId!=''"> AND uk.chapter_id=#{chapterId}  </if>
					AND uk.teaching_class_id=#{teachingClassId} )  AS grossObjectiveScore
		FROM sys_user AS a
		JOIN sys_student_classes AS sc ON sc.classes_id = #{classesId} AND a.user_code = sc.student_id
		WHERE a.status = '0' AND  a.user_type = '1'
	</select>
</mapper>