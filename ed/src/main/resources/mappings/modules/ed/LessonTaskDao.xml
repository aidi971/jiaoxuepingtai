<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.langheng.modules.ed.dao.LessonTaskDao">

	<select id="findList" resultType="LessonTask">
		SELECT ${sqlMap.column.toSql()},tg.whether_file AS whether_file, tg.file_id AS subjectivityFileId
		FROM ${sqlMap.table.toSql()}
		LEFT JOIN ed_test_gather as tg  ON  tg.gather_id = a.task_id
		<where>
			${sqlMap.where.toSql()}
		</where>
		ORDER BY ${sqlMap.order.toSql()}
	</select>
	
	<!-- 查询数据 -->
	<select id="findListHadPush" resultType="LessonTask">
		SELECT ${sqlMap.column.toSql()}
		FROM ${sqlMap.table.toSql()}
		<where>
			${sqlMap.where.toSql()}
			AND a.lesson_task_id in (SELECT lesson_task_id FROM ed_teaching_class_lesson_task AS tclk  WHERE  tclk.teaching_class_id=#{teachingClassId}  )
		</where>
		ORDER BY ${sqlMap.order.toSql()}
	</select>

	<!-- 查询数据 -->
	<select id="findCountHadPush" resultType="java.lang.Long">
		SELECT count(1)
		FROM ${sqlMap.table.toSql()}
		<where>
			${sqlMap.where.toSql()}
			AND a.lesson_task_id in (SELECT lesson_task_id FROM ed_teaching_class_lesson_task AS tclk  WHERE  tclk.teaching_class_id=#{teachingClassId}  )
		</where>
		ORDER BY ${sqlMap.order.toSql()}
	</select>

	<select id="findListStuFinishDetail" resultType="LessonTask">
		SELECT ${sqlMap.column.toSql()},
		(SELECT count(1) FROM ed_user_task AS ut WHERE ut.user_id=#{studentId} AND ut.lesson_task_id=a.lesson_task_id ) AS finishState,
		(SELECT max(ut.score) FROM ed_user_task AS ut WHERE ut.user_id=#{studentId} AND ut.lesson_task_id=a.lesson_task_id ) AS studentScore
		FROM ${sqlMap.table.toSql()}
		<where>
			${sqlMap.where.toSql()}
			AND a.lesson_task_id in (SELECT lesson_task_id FROM ed_teaching_class_lesson_task AS tclk  WHERE  tclk.teaching_class_id=#{teachingClassId}  )
		</where>
		ORDER BY ${sqlMap.order.toSql()}
	</select>

	<select id="getTotalObjectiveDefaultScore" resultType="java.lang.Float">
		SELECT SUM(lt.score) FROM ed_lesson_task AS lt
		JOIN ed_teaching_class_lesson_task AS tclk ON tclk.lesson_task_id = lt.lesson_task_id
			AND tclk.teaching_class_id=#{teachingClassId}
		WHERE  lt.type="3" AND
			<if test="chapterId!=null and chapterId!=''">
				lt.chapter_id=#{chapterId} AND
			</if>
			lt.lesson_task_id NOT IN
			(SELECT lesson_task_id FROM ed_teaching_class_score AS tcs WHERE  tcs.teaching_class_id =#{teachingClassId} )
	</select>

	<select id="getTotalObjectiveReSetScore" resultType="java.lang.Float">
		SELECT SUM(tcs.score) FROM ed_lesson_task AS lt
		JOIN ed_teaching_class_lesson_task AS tclk ON tclk.lesson_task_id = lt.lesson_task_id AND tclk.teaching_class_id=#{teachingClassId}
		JOIN ed_teaching_class_score AS tcs ON tcs.teaching_class_id =#{teachingClassId}
		 	AND tcs.lesson_task_id=lt.lesson_task_id
		WHERE
			<if test="chapterId!=null and chapterId!=''">
				lt.chapter_id=#{chapterId} AND
			</if>
			lt.type="3"
	</select>

</mapper>